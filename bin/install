#!/usr/bin/env bash

set -e

source "$(dirname "$0")"/utils.sh

install_nodejs() {
  local install_type=$1
  local version=$2
  local install_path=$3

  echo "node-build $version $install_path"
  if [ "$install_type" = "ref" ]; then
    $(node_build_path) /dev/stdin "$install_path" <<<"install_package \"node-$version\" \"https://github.com/nodejs/node/archive/$version.tar.gz\""
  else
    $(node_build_path) "$version" "$install_path"
  fi
}

install_default_npm_packages() {
  local default_npm_packages="${HOME}/.default-npm-packages"

  if [ ! -f "$default_npm_packages" ]; then return; fi

  while read -r name; do
    echo -ne "\nInstalling \e[33m${name}\e[39m npm package... "

    PATH="$ASDF_INSTALL_PATH/bin:$PATH" npm install -g $name > /dev/null 2>&1
    if [[ $? -eq 0 ]]; then
      echo -e "\e[32mSUCCESS\e[39m"
    else
      echo -e "\e[31mFAIL\e[39m"
    fi
  done < "$default_npm_packages"
}

ensure_node_build_installed
install_nodejs "$ASDF_INSTALL_TYPE" "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"
install_default_npm_packages
